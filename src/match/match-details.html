<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/debounce.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../player/player-avatar.html">
<link rel="import" href="../styles/app-styles.html">

<dom-module id="match-details">
  <template>
    <style include="app-styles"></style>
    <style>
    paper-input {
      margin: 1rem;
      --paper-input-container-input: {
        font-size: 4rem;
      };
    }
    .right{
      text-align: right;
    }
    p {
      font-size: 4rem;
    }
    .player-info {
      margin: 1rem;
      text-align: center;
    }
    paper-button.danger {
      background-color: var(--paper-red-600);
      color: var(--text-primary-color);
    }
    .player-1-score, .player-2-score{
      @apply --layout-flex;
      @apply --layout-horizontal;
      @apply --layout-center-justified;
    }
    .player-1-score p, .player-2-score p{
      text-align: center;
    }
    @media (max-width: 767px) {
      .player-1-score {
        @apply --layout-vertical;
      }
      .player-2-score {
        @apply --layout-vertical-reverse;
      }
    }
    </style>

    <firebase-document
      id="fb"
      data="{{match}}"
      path="/users/[[userUid]]/matches/[[matchUid]]">
    </firebase-document>
    <firebase-document
      data="{{player1}}"
      path="/players/[[match.player1Uid]]">
    </firebase-document>
    <firebase-document
      data="{{player2}}"
      path="/players/[[match.player2Uid]]">
    </firebase-document>

    <section class="paper-material">
      <div class="layout horizontal  center-center">
        <div class="player-1-score">
          <div class="player-info">
            <player-avatar src="[[player1.photoURL]]" big></player-avatar>
            <h1>[[player1.displayName]]</h1>
          </div>
          <paper-input
            id="player1Score"
            class="right"
            hidden="[[match.final]]"
            type="number"
            min="0"
            max="99"
            label="Score"
            on-change="_updateScores">
          </paper-input>
          <p hidden="[[!match.final]]">[[match.player1Score]]</p>
        </div>
        <p>-</p>
        <div class="player-2-score">
          <paper-input
            id="player2Score"
            hidden="[[match.final]]"
            type="number"
            min="0"
            max="99"
            label="Score"
            on-change="_updateScores">
          </paper-input>
          <p hidden="[[!match.final]]">[[match.player2Score]]</p>
          <div class="player-info">
            <player-avatar src="[[player2.photoURL]]" big></player-avatar>
            <h1>[[player2.displayName]]</h1>
          </div>
        </div>
      </div>
      <div class="buttons">
        <paper-button class="danger" on-tap="_reject" hidden="[[!_canReject]]">Reject</paper-button>
        <paper-button raised on-tap="_accept" disabled="[[_accepted]]" hidden="[[match.final]]">Accept Score</paper-button>
      </div>
    </section>

  </template>
  <script>
    class MatchDetails extends Polymer.Element {
      static get is() { return 'match-details'; }
      static get properties() {
        return {
          _accepted: {
            type: Boolean,
            computed: '_computedAccepted(userUid, match.*)'
          },
          _canReject: {
            type: Boolean,
            computed: '_computedCanReject(userUid, match, match.final)'
          }
        };
      }
      static get observers() {
        return ['_updateInputs(match.player1Score, match.player2Score)']
      }
      _accept(){
        if(this.userUid == this.match.player1Uid)
          this.set('match.player1Accepted', true);
        else
          this.set('match.player2Accepted', true);
      }
      _reject(){
        this.$.fb.destroy();
        window.history.pushState({}, null, '/');
        window.dispatchEvent(new CustomEvent('location-changed'));
      }
      _computedAccepted(userUid){
        if(!userUid || !this.match) return;
        if(userUid == this.match.player1Uid)
          return this.match.player1Accepted;
        return this.match.player2Accepted
      }
      _computedCanReject(userUid, match) {
        if(!userUid || !match) return;
        return userUid == this.match.player2Uid && !this.match.final;
      }
      _updateInputs(player1Score, player2Score){
        this.$.player1Score.value = player1Score;
        this.$.player2Score.value= player2Score;
      }
      _updateScores() {
        this._ScoresDebouncer = Polymer.Debouncer.debounce(
          this._ScoresDebouncer,
          Polymer.Async.timeOut.after(200),
          () => {
            this.set('match.player1Score', this.$.player1Score.value);
            this.set('match.player2Score', this.$.player2Score.value);
          }
        );
      }
    }

    window.customElements.define(MatchDetails.is, MatchDetails);
  </script>
</dom-module>
